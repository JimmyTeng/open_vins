# 零速度更新（Zero Velocity Update）公式推导

## 1. 基本假设

零速度更新的核心思想是：当系统静止时，真实的角速度和加速度应该为零：

$$\boldsymbol{\omega}_{true} = \mathbf{0}$$

$$\mathbf{a}_{true} = \mathbf{0}$$

## 2. IMU测量模型

### 2.1 角速度测量模型

IMU测量的角速度可以表示为：

$$\boldsymbol{\omega}_m = \boldsymbol{\omega}_{true} + \mathbf{b}_g + \mathbf{n}_g$$

其中：
- $\boldsymbol{\omega}_m$：IMU测量的角速度
- $\boldsymbol{\omega}_{true}$：真实的角速度
- $\mathbf{b}_g$：陀螺仪偏置
- $\mathbf{n}_g$：陀螺仪测量噪声

### 2.2 加速度测量模型

IMU测量的加速度可以表示为：

$$\mathbf{a}_m = \mathbf{a}_{true} + \mathbf{b}_a + {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g} + \mathbf{n}_a$$

其中：
- $\mathbf{a}_m$：IMU测量的加速度
- $\mathbf{a}_{true}$：真实的加速度
- $\mathbf{b}_a$：加速度计偏置
- ${}^{I}_G\mathbf{R}$：从全局坐标系到IMU坐标系的旋转矩阵
- ${}^G\mathbf{g}$：全局坐标系下的重力向量
- $\mathbf{n}_a$：加速度计测量噪声

## 3. 零速度更新的测量方程

### 3.1 角速度残差

由于 $\boldsymbol{\omega}_{true} = \mathbf{0}$，我们有：

$$\tilde{\mathbf{z}}_\omega = \mathbf{0} - (\boldsymbol{\omega}_m - \mathbf{b}_g - \mathbf{n}_g) = -(\boldsymbol{\omega}_m - \mathbf{b}_g - \mathbf{n}_g)$$

在代码实现中，首先对IMU测量值进行标定和偏置补偿：

$$\hat{\boldsymbol{\omega}} = {}^{IMU}_{GYRO}\mathbf{R} \cdot \mathbf{D}_w \cdot (\boldsymbol{\omega}_m - \mathbf{b}_g - \mathbf{T}_g \cdot \hat{\mathbf{a}})$$

其中：
- ${}^{IMU}_{GYRO}\mathbf{R}$：从陀螺仪坐标系到IMU坐标系的旋转
- $\mathbf{D}_w$：陀螺仪标定矩阵
- $\mathbf{T}_g$：陀螺仪-加速度计耦合矩阵
- $\hat{\mathbf{a}}$：估计的加速度（见下文）

因此，角速度残差为：

$$\tilde{\mathbf{z}}_\omega = -\hat{\boldsymbol{\omega}}$$

### 3.2 加速度残差

由于 $\mathbf{a}_{true} = \mathbf{0}$，我们有：

$$\tilde{\mathbf{z}}_a = \mathbf{0} - (\mathbf{a}_m - \mathbf{b}_a - {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g} - \mathbf{n}_a) = -(\mathbf{a}_m - \mathbf{b}_a - {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g} - \mathbf{n}_a)$$

在代码实现中，首先对加速度测量值进行标定和偏置补偿：

$$\hat{\mathbf{a}} = {}^{IMU}_{ACC}\mathbf{R} \cdot \mathbf{D}_a \cdot (\mathbf{a}_m - \mathbf{b}_a)$$

其中：
- ${}^{IMU}_{ACC}\mathbf{R}$：从加速度计坐标系到IMU坐标系的旋转
- $\mathbf{D}_a$：加速度计标定矩阵

因此，加速度残差为：

$$\tilde{\mathbf{z}}_a = -(\hat{\mathbf{a}} - {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g})$$

## 4. 白化处理（Whitening）

为了处理连续时间噪声到离散时间的转换，代码中使用了白化权重：

$$w_\omega = \frac{\sqrt{\Delta t}}{\sigma_w}$$

$$w_a = \frac{\sqrt{\Delta t}}{\sigma_a}$$

其中：
- $\Delta t$：IMU测量时间间隔
- $\sigma_w$：陀螺仪连续时间噪声标准差
- $\sigma_a$：加速度计连续时间噪声标准差

白化后的残差为：

$$\tilde{\mathbf{z}}_\omega^{whitened} = -w_\omega \cdot \hat{\boldsymbol{\omega}}$$

$$\tilde{\mathbf{z}}_a^{whitened} = -w_a \cdot (\hat{\mathbf{a}} - {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g})$$

## 5. 雅可比矩阵（Jacobian）

### 5.1 状态变量顺序

代码中的状态变量顺序为：$\mathbf{x} = [\mathbf{q}_{GtoI}, \mathbf{b}_g, \mathbf{b}_a, \mathbf{v}_{IinG}]^T$

其中：
- $\mathbf{q}_{GtoI}$：从全局坐标系到IMU坐标系的四元数（姿态）
- $\mathbf{b}_g$：陀螺仪偏置
- $\mathbf{b}_a$：加速度计偏置
- $\mathbf{v}_{IinG}$：IMU在全局坐标系下的速度（仅在积分加速度约束时使用）

### 5.2 角速度残差对状态的雅可比

$$\frac{\partial \tilde{\mathbf{z}}_\omega}{\partial \mathbf{b}_g} = -w_\omega \cdot \mathbf{I}_{3 \times 3}$$

对其他状态变量的导数为零。

### 5.3 加速度残差对状态的雅可比

#### 5.3.1 对姿态的雅可比

$$\frac{\partial \tilde{\mathbf{z}}_a}{\partial \mathbf{q}_{GtoI}} = -w_a \cdot \lfloor {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g} \times \rfloor$$

其中 $\lfloor \mathbf{v} \times \rfloor$ 是向量 $\mathbf{v}$ 的反对称矩阵（skew-symmetric matrix）：

$$\lfloor \mathbf{v} \times \rfloor = \begin{bmatrix}
0 & -v_z & v_y \\
v_z & 0 & -v_x \\
-v_y & v_x & 0
\end{bmatrix}$$

#### 5.3.2 对加速度偏置的雅可比

$$\frac{\partial \tilde{\mathbf{z}}_a}{\partial \mathbf{b}_a} = -w_a \cdot \mathbf{I}_{3 \times 3}$$

## 6. 完整的测量模型

对于 $N$ 个IMU测量值，完整的残差向量为：

$$\tilde{\mathbf{z}} = \begin{bmatrix}
\tilde{\mathbf{z}}_{\omega,0} \\
\tilde{\mathbf{z}}_{a,0} \\
\tilde{\mathbf{z}}_{\omega,1} \\
\tilde{\mathbf{z}}_{a,1} \\
\vdots \\
\tilde{\mathbf{z}}_{\omega,N-1} \\
\tilde{\mathbf{z}}_{a,N-1}
\end{bmatrix} \in \mathbb{R}^{6N}$$

完整的雅可比矩阵为：

$$\mathbf{H} = \begin{bmatrix}
\mathbf{0} & -w_{\omega,0}\mathbf{I} & \mathbf{0} & \mathbf{0} \\
-w_{a,0}\lfloor {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g} \times \rfloor & \mathbf{0} & -w_{a,0}\mathbf{I} & \mathbf{0} \\
\mathbf{0} & -w_{\omega,1}\mathbf{I} & \mathbf{0} & \mathbf{0} \\
-w_{a,1}\lfloor {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g} \times \rfloor & \mathbf{0} & -w_{a,1}\mathbf{I} & \mathbf{0} \\
\vdots & \vdots & \vdots & \vdots
\end{bmatrix}$$

## 7. 噪声协方差矩阵

白化后的噪声协方差矩阵为：

$$\mathbf{R} = \alpha \cdot \mathbf{I}_{6N \times 6N}$$

其中 $\alpha$ 是噪声乘数（`zupt_noise_multiplier`），通常设置为较大的值（如50-100）以处理实际中的额外噪声源（如电机振动等）。

## 8. 偏置传播

在更新之前，偏置会按照随机游走模型进行传播：

$$\mathbf{b}_g(t+\Delta t) = \mathbf{b}_g(t) + \mathbf{n}_{bg} \cdot \sqrt{\Delta t}$$

$$\mathbf{b}_a(t+\Delta t) = \mathbf{b}_a(t) + \mathbf{n}_{ba} \cdot \sqrt{\Delta t}$$

偏置传播的协方差矩阵为：

$$\mathbf{Q}_{bias} = \begin{bmatrix}
\Delta t \cdot \sigma_{bg}^2 \cdot \mathbf{I}_{3 \times 3} & \mathbf{0} \\
\mathbf{0} & \Delta t \cdot \sigma_{ba}^2 \cdot \mathbf{I}_{3 \times 3}
\end{bmatrix}$$

其中：
- $\sigma_{bg}$：陀螺仪偏置随机游走噪声标准差
- $\sigma_{ba}$：加速度计偏置随机游走噪声标准差

## 9. Chi-squared检验

零速度检测使用chi-squared检验：

$$\chi^2 = \tilde{\mathbf{z}}^T (\mathbf{H}\mathbf{P}\mathbf{H}^T + \mathbf{R})^{-1} \tilde{\mathbf{z}} < \chi^2_{threshold}$$

其中：
- $\mathbf{P}$：状态协方差矩阵（考虑偏置传播后）
- $\chi^2_{threshold}$：chi-squared阈值（置信度95%）

如果 $\chi^2$ 小于阈值且速度大小 $|\mathbf{v}_{IinG}|$ 小于最大速度阈值，则接受零速度更新。

## 10. EKF更新

如果零速度检测通过，则执行标准EKF更新：

$$\mathbf{K} = \mathbf{P}\mathbf{H}^T(\mathbf{H}\mathbf{P}\mathbf{H}^T + \mathbf{R})^{-1}$$

$$\Delta\mathbf{x} = \mathbf{K}\tilde{\mathbf{z}}$$

$$\mathbf{x}_{new} = \mathbf{x}_{old} + \Delta\mathbf{x}$$

$$\mathbf{P}_{new} = (\mathbf{I} - \mathbf{K}\mathbf{H})\mathbf{P}_{old}$$

## 11. 代码实现对应关系

| 公式 | 代码位置 | 说明 |
|------|---------|------|
| $\hat{\boldsymbol{\omega}}$ | 第177行 | `w_hat` |
| $\hat{\mathbf{a}}$ | 第176行 | `a_hat` |
| $w_\omega$ | 第184行 | `w_omega` |
| $w_a$ | 第185行 | `w_accel` |
| $\tilde{\mathbf{z}}_\omega$ | 第189行 | `res.block(6*i+0, 0, 3, 1)` |
| $\tilde{\mathbf{z}}_a$ | 第191行 | `res.block(6*i+3, 0, 3, 1)` |
| $\frac{\partial \tilde{\mathbf{z}}_\omega}{\partial \mathbf{b}_g}$ | 第198行 | `H.block(6*i+0, 3, 3, 3)` |
| $\frac{\partial \tilde{\mathbf{z}}_a}{\partial \mathbf{q}}$ | 第200行 | `H.block(6*i+3, 0, 3, 3)` |
| $\frac{\partial \tilde{\mathbf{z}}_a}{\partial \mathbf{b}_a}$ | 第201行 | `H.block(6*i+3, 6, 3, 3)` |
| $\mathbf{Q}_{bias}$ | 第222-224行 | `Q_bias` |
| $\chi^2$ 检验 | 第234行 | `chi2` 计算 |
| EKF更新 | 第302行 | `StateHelper::EKFUpdate` |

## 12. 总结

零速度更新的核心公式可以总结为：

1. **测量残差**：
   - 角速度：$\tilde{\mathbf{z}}_\omega = -w_\omega \cdot \hat{\boldsymbol{\omega}}$
   - 加速度：$\tilde{\mathbf{z}}_a = -w_a \cdot (\hat{\mathbf{a}} - {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g})$

2. **雅可比矩阵**：
   - 对偏置：$\frac{\partial \tilde{\mathbf{z}}_\omega}{\partial \mathbf{b}_g} = -w_\omega \mathbf{I}$，$\frac{\partial \tilde{\mathbf{z}}_a}{\partial \mathbf{b}_a} = -w_a \mathbf{I}$
   - 对姿态：$\frac{\partial \tilde{\mathbf{z}}_a}{\partial \mathbf{q}} = -w_a \lfloor {}^{I}_G\mathbf{R} \cdot {}^G\mathbf{g} \times \rfloor$

3. **更新过程**：使用标准EKF更新公式，通过chi-squared检验确保更新的有效性。
